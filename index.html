<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <title>Utleide malerier – live tracking</title>

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin="anonymous"
  />

  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      background: #0b0c0e;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    #map {
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100vh;
    }
    /* Unngå hvitt “flash” bak tiles */
    #map, .leaflet-container, .leaflet-pane, .leaflet-layer { background:#0b0c0e; }
    .leaflet-tile { background-color:#0b0c0e !important; }

    .btn {
      appearance: none;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      color: #fff;
      border-radius: 10px;
      padding: 8px 10px;
      font: inherit;
      cursor: pointer;
    }
    .btn:active { transform: translateY(1px); }

    /* Pulsmarkør */
    .pulse-marker {
      width: 14px; height: 14px;
      background: #ff4455; border: 2px solid #fff; border-radius: 50%;
      box-shadow: 0 0 0 0 rgba(255,68,85,0.7);
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(255,68,85,0.6); }
      70% { box-shadow: 0 0 0 16px rgba(255,68,85,0); }
      100% { box-shadow: 0 0 0 0 rgba(255,68,85,0); }
    }

    .art-popup h3 { margin: 0 0 8px; font-size: 16px; line-height: 1.2; }
    .art-popup img {
      width: 220px; max-width: 70vw; height: auto;
      border-radius: 10px; display: block; border: 1px solid #ddd;
    }

    /* ---------- Bottom sheet (footer) ---------- */
    .sheet {
      position: fixed;
      left: 0; right: 0;
      bottom: 0;
      height: 64px;                 /* start-høyde (min) */
      max-height: 85dvh;            /* hvor mye den kan dras opp */
      background: rgba(18,18,22,0.75);
      -webkit-backdrop-filter: blur(8px);
      backdrop-filter: blur(8px);
      border-top: 1px solid rgba(255,255,255,0.08);
      color: #eaeaea;
      z-index: 5000;
      transition: height .2s ease;
      touch-action: none;           /* for smooth pointer events på mobil */
    }
    .sheet.dragging { transition: none; }

    .sheet-header {
      display: flex; align-items: center; justify-content: space-between; gap: 8px;
      padding: 10px 12px;
      padding-bottom: 8px;
    }
    .sheet-title {
      display:flex; align-items:center; gap:8px; font-weight:600; letter-spacing: .2px;
    }
    .brand-dot {
      width: 8px; height: 8px; border-radius: 50%;
      background:#f45; box-shadow: 0 0 0 2px rgba(255, 68, 85, 0.3);
    }
    .handle {
      position: absolute; left: 50%; top: 6px; transform: translateX(-50%);
      width: 44px; height: 5px; border-radius: 999px; background: rgba(255,255,255,0.25);
    }
    .sheet-actions { display:flex; gap:8px; }

    .sheet-body {
      border-top: 1px solid rgba(255,255,255,0.06);
      padding: 6px 8px 10px 8px;
      overflow: auto;
      height: calc(100% - 48px); /* resten etter header */
    }

    .list {
      margin: 6px 0 0 0; padding: 0; list-style: none;
      display: grid; gap: 6px;
    }
    .list-item {
      display:flex; align-items:center; justify-content: space-between; gap:10px;
      padding: 10px 12px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 12px;
      cursor: pointer;
    }
    .list-item:active { transform: translateY(1px); }
    .list-title { font-weight:600; font-size:14px; color:#fff; }
    .list-sub { font-size:12px; color:#cfcfcf; opacity: .9; }
    .go { font-size:12px; padding:6px 8px; border-radius:8px; }

    .leaflet-control-attribution {
      background: rgba(18,18,22,0.6) !important;
      color:#bdbdbd !important; border-radius: 10px !important;
      padding: 2px 6px !important; font-size:10px !important;
      border:1px solid rgba(255,255,255,0.08) !important;
      margin-bottom: 6px !important; /* litt opp så den ikke ligger helt i bunnen */
    }
  </style>
</head>
<body>
  <div id="map" role="application" aria-label="Kart over sporingspunkter for malerier"></div>

  <!-- Bottom sheet -->
  <div class="sheet" id="sheet" style="height:64px;">
    <div class="handle" id="handle" aria-hidden="true"></div>
    <div class="sheet-header" id="sheetHeader">
      <div class="sheet-title">
        <span class="brand-dot" aria-hidden="true"></span>
        <span>Utleide malerier – Live</span>
      </div>
      <div class="sheet-actions">
        <button class="btn" id="btnLocate" title="Min posisjon">⦿</button>
        <button class="btn" id="btnFit" title="Se alle">Se alle</button>
      </div>
    </div>
    <div class="sheet-body" id="sheetBody">
      <ul class="list" id="artList"></ul>
    </div>
  </div>

  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin="anonymous"
  ></script>

  <script>
    /* ----------------- Leaflet init ----------------- */
    const map = L.map('map', {
      zoomControl: false,          // vi gjemmer +/-
      scrollWheelZoom: true,
      dragging: true,
      tap: true,
      zoomAnimation: false,
      markerZoomAnimation: false,
      fadeAnimation: true
    });

    const tiles = L.tileLayer(
      'https://tiles.stadiamaps.com/tiles/alidade_smooth/{z}/{x}/{y}{r}.png',
      {
        maxZoom: 19,
        keepBuffer: 6,
        updateWhenZooming: false,
        attribution: '&copy; OSM & Stadia Maps',
        noWrap: true,
        bounds: [[-85,-180],[85,180]]
      }
    ).addTo(map);

    // Geolokasjon
    map.locate({ maxZoom: 7, enableHighAccuracy: true, timeout: 8000, maximumAge: 0 });
    let myPosition = null, myCircle = null;

    map.on('locationfound', (e) => {
      myPosition = e.latlng;
      myCircle = L.circleMarker(e.latlng, {
        radius: 8, fillColor: '#4fc3f7', color: '#fff', weight: 2, opacity: 1, fillOpacity: 0.9
      }).addTo(map);
    });
    map.on('locationerror', (e) => console.warn('Posisjon-feil:', e.message));

    /* ----------------- Data ----------------- */
    const points = [
      { artwork:"Vinternatt", location:"Hamburger Kunsthalle", coords:[53.5552936,10.0030010953872], img:"https://upload.wikimedia.org/wikipedia/commons/thumb/d/de/Edvard_Munch_-_Winter_Night_-_MM.M.00456_-_Munch_Museum.jpg/330px-Edvard_Munch_-_Winter_Night_-_MM.M.00456_-_Munch_Museum.jpg" },
      { artwork:"Natt i Saint Cloud", location:"Guggenheim Bilbao Museum", coords:[43.2691,-2.9340], img:"https://upload.wikimedia.org/wikipedia/commons/thumb/a/a4/Edvard_Munch_-_Night_in_Saint-Cloud_%281890%29%2C_NG.M.01111.jpg/500px-Edvard_Munch_-_Night_in_Saint-Cloud_%281890%29%2C_NG.M.01111.jpg" },
      { artwork:"Vampyr", location:"Hjemme", coords:[59.90953131942386,10.523799997891706], img:"https://upload.wikimedia.org/wikipedia/commons/thumb/a/a2/Edvard_Munch_-_Vampire_%281895%29_-_Google_Art_Project.jpg/960px-Edvard_Munch_-_Vampire_%281895%29_-_Google_Art_Project.jpg" },
      { artwork:"Aften på Karl Johan", location:"Berlinische Galerie", coords:[52.5039,13.39823], img:"https://upload.wikimedia.org/wikipedia/commons/thumb/8/83/Evening_on_Karl_Johan_Street.jpg/330px-Evening_on_Karl_Johan_Street.jpg" },
      { artwork:"På operasjonsbordet", location:"Berlinische Galerie", coords:[52.5039,13.39823], img:"https://upload.wikimedia.org/wikipedia/commons/thumb/9/9f/Edvard_Munch_-_On_the_Operating_Table_-_MM.M.00022_-_Munch_Museum.jpg/330px-Edvard_Munch_-_On_the_Operating_Table_-_MM.M.00022_-_Munch_Museum.jpg" },
      { artwork:"Dødskamp", location:"National Museum in Warsaw", coords:[52.23167,21.02472], img:"https://upload.wikimedia.org/wikipedia/commons/thumb/6/6c/Edvard_Munch%2C_Dødskamp.JPG/330px-Edvard_Munch%2C_Dødskamp.JPG" },
      { artwork:"Madonna", location:"National Museum in Warsaw", coords:[52.23167,21.02472], img:"https://upload.wikimedia.org/wikipedia/commons/thumb/5/5f/Edvard_Munch_-_Madonna_-_Google_Art_Project.jpg/250px-Edvard_Munch_-_Madonna_-_Google_Art_Project.jpg" },
      { artwork:"Marats død", location:"Birmingham Museum & Art Gallery", coords:[52.4788,-1.8960], img:"https://upload.wikimedia.org/wikipedia/commons/thumb/6/69/Edvard_Munch_-_The_Death_of_Marat_-_MM.M.00351_-_Munch_Museum.jpg/330px-Edvard_Munch_-_The_Death_of_Marat_-_MM.M.00351_-_Munch_Museum.jpg" },
      { artwork:"Kvinnen", location:"Manchester Art Gallery", coords:[53.4808,-2.2379], img:"https://upload.wikimedia.org/wikipedia/commons/thumb/4/4f/Edvard_Munch_-_Woman_-_MM.M.00375_-_Munch_Museum.jpg/330px-Edvard_Munch_-_Woman_-_MM.M.00375_-_Munch_Museum.jpg" },
      { artwork:"Døden i sykeværelset", location:"Musée Matisse", coords:[43.2886,5.3840], img:"https://upload.wikimedia.org/wikipedia/commons/thumb/4/46/Edvard_Munch_-_Death_in_the_Sickroom.jpg/330px-Edvard_Munch_-_Death_in_the_Sickroom.jpg" },
      { artwork:"Fortvilelse", location:"Trondheim kunstmuseum", coords:[63.4270,10.3951], img:"https://upload.wikimedia.org/wikipedia/commons/thumb/6/61/Edvard_Munch_-_Despair_%281894%29.jpg/250px-Edvard_Munch_-_Despair_%281894%29.jpg" },
      { artwork:"Døden og barnet", location:"Munch-museet", coords:[59.9070,10.7525], img:"https://upload.wikimedia.org/wikipedia/commons/thumb/c/ce/Munch%2C_The_dead_mother_and_the_child.jpg/330px-Munch%2C_The_dead_mother_and_the_child.jpg" },
      { artwork:"Angst", location:"Henie Onstad Kunstsenter", coords:[59.8797,10.4380], img:"https://upload.wikimedia.org/wikipedia/commons/thumb/a/ae/Edvard_Munch_-_Anxiety_-_Google_Art_Project.jpg/250px-Edvard_Munch_-_Anxiety_-_Google_Art_Project.jpg" },
      { artwork:"Selvportrett i helvette", location:"Budapest", coords:[47.4979,19.0402], img:"https://upload.wikimedia.org/wikipedia/commons/thumb/f/f4/Edvard_Munch_-_Self-Portrait_in_Hell_-_Google_Art_Project.jpg/250px-Edvard_Munch_-_Self-Portrait_in_Hell_-_Google_Art_Project.jpg" },
      { artwork:"Døden og barnet", location:"Museum voor Schone Kunsten Gent", coords:[51.0569,3.7174], img:"https://upload.wikimedia.org/wikipedia/commons/thumb/0/09/Edvard_Munch_-_Death_and_the_Child_%281899%29%2C_Kunsthalle_Bremen.jpg/250px-Edvard_Munch_-_Death_and_the_Child_%281899%29%2C_Kunsthalle_Bremen.jpg" }
    ];

    /* ----------------- Markører & popups ----------------- */
    const dotIcon = L.divIcon({ className:'pulse-marker', iconSize:[14,14], iconAnchor:[7,7] });

    const markers = points.map(p => {
      const m = L.marker(p.coords, { icon: dotIcon }).addTo(map);
      const popupHtml = `
        <div class="art-popup">
          <h3>${p.artwork}</h3>
          <p style="margin:0 0 8px">${p.location}</p>
          <img alt="Maleribilde for ${p.artwork}" src="${p.img}">
        </div>`;
      m.bindPopup(popupHtml, {
        autoPan: true, keepInView: true, closeButton:true
      });
      // Når popup åpnes: pan innsiden m/ padding i bunn = sheet-høyde
      m.on('click', () => {
        const z = Math.max(map.getZoom(), 13);
        map.setView(p.coords, z, { animate: true });
        setTimeout(() => {
          m.openPopup();
          panForSheet(p.coords);
        }, 0);
      });
      return m;
    });

    const group = L.featureGroup(markers);
    map.fitBounds(group.getBounds().pad(0.2));

    // Når en vilkårlig popup åpnes (inkl. via listeklikk)
    map.on('popupopen', (e) => panForSheet(e.popup.getLatLng()));

    function panForSheet(latlng){
      const padY = getSheetHeight() + 16; // litt margin
      map.panInside(latlng, { paddingBottomRight: [12, padY], paddingTopLeft: [12, 12], animate: true });
    }

    /* ----------------- Liste i sheet ----------------- */
    const listEl = document.getElementById('artList');
    points.forEach((p, idx) => {
      const li = document.createElement('li');
      li.className = 'list-item';
      li.innerHTML = `
        <div>
          <div class="list-title">${p.artwork}</div>
          <div class="list-sub">${p.location}</div>
        </div>
        <button class="btn go">Vis</button>
      `;
      li.addEventListener('click', (ev) => {
        ev.preventDefault();
        ev.stopPropagation();

        const m = markers[idx];
        const z = Math.max(map.getZoom(), 13);

        // Lukk sheetet først for å gi kartet full høyde
        closeSheet();

        // Fly til punktet og åpne popup når vi er fremme
        map.flyTo(p.coords, z, { duration: .6 });
        map.once('moveend', () => {
          m.openPopup();
          // siden sheet allerede er lukket, trenger vi ikke ekstra padding her
        });
      });
      listEl.appendChild(li);
    });

    /* ----------------- UI-knapper ----------------- */
    document.getElementById('btnFit').addEventListener('click', () => {
      map.fitBounds(group.getBounds().pad(0.2));
    });

    document.getElementById('btnLocate').addEventListener('click', () => {
      if (!myPosition) return;
      if (myCircle) myCircle.setStyle({ opacity: 0, fillOpacity: 0 });
      map.flyTo(myPosition, Math.max(map.getZoom(), 15), { duration: .5 });
      map.once('zoomend', () => {
        if (myCircle) myCircle.setStyle({ opacity: 1, fillOpacity: 0.9 });
      });
    });

    /* ----------------- Dragbar bottom sheet ----------------- */
    const sheet = document.getElementById('sheet');
    const header = document.getElementById('sheetHeader');
    const handle = document.getElementById('handle');

    const MIN_H = 64;                       // lukket
    const MID_H = Math.round(window.innerHeight * 0.35);
    const MAX_H = Math.round(window.innerHeight * 0.85);

    function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }
    function getSheetHeight(){ return parseInt(sheet.style.height || MIN_H, 10); }

    let startY=0, startH=MIN_H, dragging=false;

    function onPointerDown(e){
      dragging = true;
      sheet.classList.add('dragging');
      startY = e.clientY || (e.touches && e.touches[0].clientY) || 0;
      startH = getSheetHeight();
      window.addEventListener('pointermove', onPointerMove);
      window.addEventListener('pointerup', onPointerUp, { once:true });
    }
    function onPointerMove(e){
      if(!dragging) return;
      const y = e.clientY || (e.touches && e.touches[0].clientY) || 0;
      const dy = startY - y; // dra opp = positivt
      const next = clamp(startH + dy, MIN_H, MAX_H);
      sheet.style.height = next + 'px';
    }
    function onPointerUp(){
      dragging = false;
      sheet.classList.remove('dragging');
      // snap til nærmeste (min/mid/max)
      const h = getSheetHeight();
      const targets = [MIN_H, MID_H, MAX_H];
      const snap = targets.reduce((a,b)=> Math.abs(b-h) < Math.abs(a-h) ? b : a, targets[0]);
      sheet.style.height = snap + 'px';
    }
    
    function closeSheet() {
      sheet.style.height = MIN_H + 'px';
    }

    // Gjør både header og handle dragbare
    ;[header, handle].forEach(el => {
      el.style.cursor = 'grab';
      el.addEventListener('pointerdown', onPointerDown);
    });

    // Oppdater maks-høyde ved resize (rotasjon etc.)
    window.addEventListener('resize', () => {
      const h = getSheetHeight();
      const newMax = Math.round(window.innerHeight * 0.85);
      const newMid = Math.round(window.innerHeight * 0.35);
      if (h > newMax) sheet.style.height = newMax + 'px';
    });

    // Åpne sheet til "mid" ved første scroll i body, valgfritt:
    // sheet.style.height = MID_H + 'px';

    // For at scrolling inne i sheet skal fungere fint på mobil
    const sheetBody = document.getElementById('sheetBody');
    sheetBody.addEventListener('touchstart', (e) => { e.stopPropagation(); }, { passive:true });

  </script>
</body>
</html>